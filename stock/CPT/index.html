<!DOCTYPE html>
<html lang="ko">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-G2HLEL6YBR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-G2HLEL6YBR');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026-01-22 CPT ì£¼ê°€ ì „ë§ & ëª©í‘œê°€ | ìº ë˜ í”„ë¡œí¼í‹° íŠ¸ëŸ¬ìŠ¤íŠ¸ AI ë¶„ì„ - ë‚˜ìŠ¤í”½</title>
    <meta name="description" content="[2026-01-22] ìº ë˜ í”„ë¡œí¼í‹° íŠ¸ëŸ¬ìŠ¤íŠ¸(CPT) ì ì • ì£¼ê°€ ë° ì›”ìŠ¤íŠ¸ë¦¬íŠ¸ ëª©í‘œê°€ ë¶„ì„. AIê°€ ì§„ë‹¨í•œ ìº ë˜ í”„ë¡œí¼í‹° íŠ¸ëŸ¬ìŠ¤íŠ¸ì˜ íˆ¬ì ë§¤ë ¥ë„ì™€ ì‹¤ì‹œê°„ í‹°ì–´ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.">
    <!-- Brand Assets -->
    <link rel="icon" type="image/png" href="/images/favicon.png">

    <!-- SEO: Canonical & Alternate Links (Initial placeholders, updated via JS) -->
    <link rel="canonical" href="https://naspick.com/stock/CPT">
    <link rel="alternate" hreflang="ko" href="https://naspick.com/stock/CPT">
    <link rel="alternate" hreflang="en" href="https://naspick.com/en/stock/CPT">
    <link rel="alternate" hreflang="x-default" href="https://naspick.com/en/stock/CPT">

    <!-- Open Graph (ê¸°ë³¸ê°’, JSì—ì„œ ë™ì  ì—…ë°ì´íŠ¸) -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="ë‚˜ìŠ¤í”½">
    <meta property="og:title" content="2026-01-22 CPT ì£¼ê°€ ì „ë§ & ëª©í‘œê°€ | ìº ë˜ í”„ë¡œí¼í‹° íŠ¸ëŸ¬ìŠ¤íŠ¸ AI ë¶„ì„ - ë‚˜ìŠ¤í”½">
    <meta property="og:description" content="[2026-01-22] ìº ë˜ í”„ë¡œí¼í‹° íŠ¸ëŸ¬ìŠ¤íŠ¸(CPT) ì ì • ì£¼ê°€ ë° ì›”ìŠ¤íŠ¸ë¦¬íŠ¸ ëª©í‘œê°€ ë¶„ì„. AIê°€ ì§„ë‹¨í•œ ìº ë˜ í”„ë¡œí¼í‹° íŠ¸ëŸ¬ìŠ¤íŠ¸ì˜ íˆ¬ì ë§¤ë ¥ë„ì™€ ì‹¤ì‹œê°„ í‹°ì–´ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.">
    <meta property="og:url" content="https://naspick.com/stock/CPT">
    <meta property="og:image" content="https://financialmodelingprep.com/image-stock/CPT.png">

    <!-- Twitter Card (ê¸°ë³¸ê°’, JSì—ì„œ ë™ì  ì—…ë°ì´íŠ¸) -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="2026-01-22 CPT ì£¼ê°€ ì „ë§ & ëª©í‘œê°€ | ìº ë˜ í”„ë¡œí¼í‹° íŠ¸ëŸ¬ìŠ¤íŠ¸ AI ë¶„ì„ - ë‚˜ìŠ¤í”½">
    <meta name="twitter:description" content="[2026-01-22] ìº ë˜ í”„ë¡œí¼í‹° íŠ¸ëŸ¬ìŠ¤íŠ¸(CPT) ì ì • ì£¼ê°€ ë° ì›”ìŠ¤íŠ¸ë¦¬íŠ¸ ëª©í‘œê°€ ë¶„ì„. AIê°€ ì§„ë‹¨í•œ ìº ë˜ í”„ë¡œí¼í‹° íŠ¸ëŸ¬ìŠ¤íŠ¸ì˜ íˆ¬ì ë§¤ë ¥ë„ì™€ ì‹¤ì‹œê°„ í‹°ì–´ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.">
    <meta name="twitter:image" content="https://financialmodelingprep.com/image-stock/CPT.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <style>
        body {
            font-family: 'Pretendard', sans-serif;
        }

        @keyframes loadBar {
            from {
                width: 0;
            }

            to {
                width: var(--width);
            }
        }

        .stat-bar {
            animation: loadBar 1.2s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }
    </style>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5643020932469823"
        crossorigin="anonymous"></script>
</head>

<body class="bg-[#1c1c1f] text-white min-h-screen flex flex-col">

    <header class="bg-[#5383e8] py-3 md:py-5 border-b border-[#3e63b0] shadow-lg z-20">
        <div
            class="container mx-auto px-4 flex flex-row items-center justify-between md:grid md:grid-cols-3 gap-3 md:gap-4">

            <div class="flex items-center gap-3 shrink-0">
                <a href="/"
                    class="text-blue-200 hover:text-white transition flex items-center justify-center p-1 rounded-full hover:bg-blue-600/20"
                    aria-label="ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°">
                    <svg class="w-6 h-6 md:w-7 md:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7">
                        </path>
                    </svg>
                </a>
                <a href="/"
                    class="text-xl md:text-3xl font-black italic tracking-tighter text-white drop-shadow-[0_4px_3px_rgba(0,0,0,0.5)] cursor-pointer hover:opacity-90 transition block">
                    NASPICK
                </a>
            </div>

            <div class="relative flex-1 max-w-[200px] md:max-w-sm flex justify-end md:justify-center md:ml-32">
                <input type="text" id="headerSearch" placeholder="í‹°ì»¤/ì¢…ëª©ëª…..."
                    class="w-full bg-[#3e63b0] text-white placeholder-blue-200/50 px-3 py-2 md:px-5 md:py-3 text-sm md:text-base rounded-full border border-blue-400 focus:outline-none focus:ring-2 focus:ring-white transition shadow-inner font-bold">
                <div id="headerSearchResults"
                    class="absolute top-full right-0 md:right-auto md:left-0 mt-2 w-64 bg-[#282830] rounded-lg shadow-xl border border-gray-700 hidden z-50 max-h-64 overflow-y-auto">
                </div>
            </div>

            <!-- Language Switcher -->
            <div class="flex items-center justify-end">
                <a id="langSwitcher" href="/en/"
                    class="flex items-center gap-1.5 text-blue-200 hover:text-white transition px-3 py-1.5 rounded-full hover:bg-[#3e63b0] group"
                    title="English">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9">
                        </path>
                    </svg>
                    <span class="text-xs font-bold tracking-wide">EN</span>
                </a>
            </div>
        </div>
    </header>

    <main id="mainContent" class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- SEO: Static H1 for bots before JS load -->
        <h1 class="sr-only">ë¯¸êµ­ ì£¼ì‹ ì‹¤ì‹œê°„ ë¶„ì„ ë° ì£¼ê°€ ì „ë§</h1>

        <div class="p-20 text-center text-gray-500">
            <h2 class="text-xl font-bold mb-2">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</h2>
            <p class="text-sm">S&P 500 ì „ì¢…ëª© AI í‹°ì–´ ë¶„ì„, ì ì • ì£¼ê°€, ì›”ìŠ¤íŠ¸ë¦¬íŠ¸ ëª©í‘œê°€ ì •ë³´ë¥¼ ë¡œë”©í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
        </div>
    </main>

    <script>
        let allData = [];

        async function init() {
            try {
                // [ë³€ê²½] ê²½ë¡œ(Path) ë°©ì‹: "/stock/TSLA" ì—ì„œ "TSLA" ì¶”ì¶œ
                const pathSegments = window.location.pathname.split('/');
                let ticker = pathSegments[pathSegments.length - 1];

                // í˜¹ì‹œ ì£¼ì†Œê°€ "/stock/TSLA/" ì²˜ëŸ¼ ëì— ìŠ¬ë˜ì‹œê°€ ë¶™ì„ ê²½ìš° ëŒ€ë¹„
                if (!ticker) ticker = pathSegments[pathSegments.length - 2];

                // URL íŒŒë¼ë¯¸í„°ê°€ ìˆë‹¤ë©´ (ê¸°ì¡´ ë°©ì‹ í•˜ìœ„ í˜¸í™˜)
                const params = new URLSearchParams(window.location.search);
                if (!ticker || ticker === 'page.html') {
                    ticker = params.get('ticker');
                }

                if (ticker) ticker = ticker.toUpperCase();

                if (!ticker || ticker === 'STOCK' || ticker === 'PAGE.HTML') {
                    // í‹°ì»¤ê°€ ì—†ëŠ” ê²½ìš° í™ˆìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ í•˜ì§€ ì•Šê³  ëŒ€ê¸° (ë˜ëŠ” ì—ëŸ¬ í‘œì‹œ)
                    // alert('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.');
                    // location.href = 'index.html';
                    // return;
                }

                if (!ticker) {
                    alert('ì¢…ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    location.href = '/';
                    return;
                }

                // data.json ê²½ë¡œ ì£¼ì˜ (ë£¨íŠ¸ ê¸°ì¤€)
                // data.json ê²½ë¡œ ì£¼ì˜ (data/ í´ë”)
                const res = await fetch('/data/data.json?t=' + new Date().getTime());
                allData = await res.json();

                const stockData = allData.find(d => d.ticker === ticker);

                if (!stockData) {
                    document.getElementById('mainContent').innerHTML = '<div class="p-20 text-center text-red-400">í•´ë‹¹ ì¢…ëª© ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                // --- SEO í•µì‹¬ ì¶”ê°€: ë™ì  íƒ€ì´í‹€, ë©”íƒ€ì„¤ëª…, Canonical Tag ---
                const today = new Date();
                const month = today.getMonth() + 1;
                const date = today.getDate();
                const dateString = `${month}ì›” ${date}ì¼`;

                // 1. Title ì—…ë°ì´íŠ¸ (SEO ìµœì í™”: 'ì£¼ê°€ ì „ë§', 'ëª©í‘œê°€' í‚¤ì›Œë“œ í¬í•¨)
                document.title = `${dateString} ${stockData.ticker} ì£¼ê°€ ì „ë§ & ëª©í‘œê°€ | ${stockData.name} AI ë¶„ì„ - ë‚˜ìŠ¤í”½`;

                // 2. Meta Description ì—…ë°ì´íŠ¸ (SEO ìµœì í™”: 'ì ì • ì£¼ê°€', 'ëª©í‘œê°€', 'ë°°ë‹¹', 'ì‹¤ì ' í‚¤ì›Œë“œ í¬í•¨)
                const metaDesc = document.querySelector('meta[name="description"]');
                const cal = stockData.calendar || {};
                let metaDividend = cal.dividend_yield ? `ë°°ë‹¹: ${cal.dividend_yield}%.` : '';
                let metaEarnings = cal.next_earnings ? `ë‹¤ìŒ ì‹¤ì : ${cal.next_earnings}.` : '';
                if (metaDesc) {
                    metaDesc.setAttribute('content',
                        `[${dateString}] ${stockData.name}(${stockData.ticker}) ì ì • ì£¼ê°€ ë° ì›”ìŠ¤íŠ¸ë¦¬íŠ¸ ëª©í‘œê°€ ë¶„ì„. í˜„ì¬ê°€ $${stockData.current_price}, ë‚˜ìŠ¤í”½ AI ì ìˆ˜ ${stockData.final_score}ì (${stockData.tier}í‹°ì–´). ${metaDividend} ${metaEarnings}`.trim()
                    );
                }

                // 3. Canonical Tag ì„¤ì •
                let canonicalLink = document.querySelector('link[rel="canonical"]');
                if (!canonicalLink) {
                    canonicalLink = document.createElement('link');
                    canonicalLink.rel = 'canonical';
                    document.head.appendChild(canonicalLink);
                }
                canonicalLink.href = `https://naspick.com/stock/${stockData.ticker}`;

                // 4. OG Image ë™ì  ì—…ë°ì´íŠ¸ (ì¢…ëª© ë¡œê³ )
                // Fallbackì´ ì´ë¯¸ í—¤ë”ì— ìˆì§€ë§Œ, ì¢…ëª©ë³„ ì´ë¯¸ì§€ê°€ ìˆë‹¤ë©´ êµì²´
                const ogImage = document.querySelector('meta[property="og:image"]');
                if (ogImage) {
                    // FMP ë¡œê³  í™œìš© (ë˜ëŠ” ì°¨íŠ¸ ì´ë¯¸ì§€)
                    ogImage.setAttribute('content', `https://financialmodelingprep.com/image-stock/${stockData.ticker.replace('.', '-')}.png`);
                }
                const twitterImage = document.querySelector('meta[name="twitter:image"]');
                if (twitterImage) {
                    twitterImage.setAttribute('content', `https://financialmodelingprep.com/image-stock/${stockData.ticker.replace('.', '-')}.png`);
                }

                // 5. OG/Twitter Title, Description, URL ë™ì  ì—…ë°ì´íŠ¸ (SEO ìµœì í™”)
                const ogTitle = document.querySelector('meta[property="og:title"]');
                if (ogTitle) ogTitle.setAttribute('content', `${dateString} ${stockData.ticker} ì£¼ê°€ ì „ë§ & ëª©í‘œê°€ | ${stockData.name} AI ë¶„ì„ - ë‚˜ìŠ¤í”½`);

                // [SEO] Add Calendar Keywords (Earnings, Dividend)
                let seoExtra = "";
                // cal is already declared above
                if (cal.next_earnings) seoExtra += ` ë‹¤ìŒ ì‹¤ì ë°œí‘œ: ${cal.next_earnings}.`;
                if (cal.dividend_yield) seoExtra += ` ë°°ë‹¹ìˆ˜ìµë¥ : ${cal.dividend_yield}%.`;
                else if (cal.last_surprise) seoExtra += ` ì§ì „ ì‹¤ì : ${cal.last_surprise > 0 ? 'ì–´ë‹ì„œí”„ë¼ì´ì¦ˆ' : 'ë¯¸ìŠ¤'}(${cal.last_surprise}%).`;

                const ogDesc = document.querySelector('meta[property="og:description"]');
                if (ogDesc) ogDesc.setAttribute('content', `[${dateString} ê¸°ì¤€] ${stockData.name}(${stockData.ticker}) AI ì •ë°€ ë¶„ì„. í˜„ì¬ê°€ $${stockData.current_price}, ë‚˜ìŠ¤í”½ ì ìˆ˜ ${stockData.final_score}ì (${stockData.tier}í‹°ì–´).${seoExtra}`);

                const ogUrl = document.querySelector('meta[property="og:url"]');
                if (ogUrl) ogUrl.setAttribute('content', `https://naspick.com/stock/${stockData.ticker}`);

                const twitterTitle = document.querySelector('meta[name="twitter:title"]');
                if (twitterTitle) twitterTitle.setAttribute('content', `${dateString} ${stockData.ticker} ì£¼ê°€ ì „ë§ & ëª©í‘œê°€ | ${stockData.name} AI ë¶„ì„ - ë‚˜ìŠ¤í”½`);

                const twitterDesc = document.querySelector('meta[name="twitter:description"]');
                if (twitterDesc) twitterDesc.setAttribute('content', `[${dateString} ê¸°ì¤€] ${stockData.name}(${stockData.ticker}) AI ì •ë°€ ë¶„ì„. í˜„ì¬ê°€ $${stockData.current_price}, ì ìˆ˜ ${stockData.final_score}ì .${seoExtra}`);

                // 6. Schema.org êµ¬ì¡°í™” ë°ì´í„° (Corporation)
                const schemaScript = document.createElement('script');
                schemaScript.type = 'application/ld+json';
                schemaScript.textContent = JSON.stringify({
                    "@context": "https://schema.org",
                    "@type": "Corporation",
                    "name": stockData.name,
                    "tickerSymbol": stockData.ticker,
                    "description": `${stockData.name} - ${stockData.sector}`,
                    "url": `https://naspick.com/stock/${stockData.ticker}`
                });
                document.head.appendChild(schemaScript);

                // 7. Breadcrumb ìŠ¤í‚¤ë§ˆ (ê²€ìƒ‰ ê²°ê³¼ì— ê²½ë¡œ í‘œì‹œ)
                const breadcrumbScript = document.createElement('script');
                breadcrumbScript.type = 'application/ld+json';
                breadcrumbScript.textContent = JSON.stringify({
                    "@context": "https://schema.org",
                    "@type": "BreadcrumbList",
                    "itemListElement": [{
                        "@type": "ListItem",
                        "position": 1,
                        "name": "í™ˆ",
                        "item": "https://naspick.com/"
                    }, {
                        "@type": "ListItem",
                        "position": 2,
                        "name": `${stockData.name} (${stockData.ticker})`,
                        "item": `https://naspick.com/stock/${stockData.ticker}`
                    }]
                });
                document.head.appendChild(breadcrumbScript);

                // 8. hreflang ë™ì  ì¶”ê°€
                const hreflangKo = document.createElement('link');
                hreflangKo.rel = 'alternate';
                hreflangKo.hreflang = 'ko';
                hreflangKo.href = `https://naspick.com/stock/${stockData.ticker}`;
                document.head.appendChild(hreflangKo);

                const hreflangDefault = document.createElement('link');
                hreflangDefault.rel = 'alternate';
                hreflangDefault.hreflang = 'x-default';
                hreflangDefault.href = `https://naspick.com/stock/${stockData.ticker}`;
                document.head.appendChild(hreflangDefault);
                // ----------------------------------------------------

                renderPage(stockData);
                initHeaderSearch();
                initFavorites(stockData.ticker); // [NEW] Initialize favorites

                // Update language switcher to maintain current page
                const langSwitcher = document.getElementById('langSwitcher');
                if (langSwitcher) {
                    langSwitcher.href = `/en/stock/${stockData.ticker}`;
                }

            } catch (err) {
                console.error(err);
                document.getElementById('mainContent').innerHTML = '<div class="p-20 text-center text-red-400">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>';
            }
        }

        function renderPage(data) {
            const SECTOR_SLUGS = {
                "ê¸°ìˆ ": "technology",
                "ì»¤ë®¤ë‹ˆì¼€ì´ì…˜": "communication",
                "ì„ì˜ì†Œë¹„ì¬": "consumer-discretionary",
                "í•„ìˆ˜ì†Œë¹„ì¬": "consumer-staples",
                "ì—ë„ˆì§€": "energy",
                "ê¸ˆìœµ": "financials",
                "í—¬ìŠ¤ì¼€ì–´": "healthcare",
                "ì‚°ì—…ì¬": "industrials",
                "ì†Œì¬": "materials",
                "ë¶€ë™ì‚°": "real-estate",
                "ìœ í‹¸ë¦¬í‹°": "utilities"
            };

            const formatMarketCap = (num) => {
                if (!num) return '-';
                if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
                if (num >= 1e9) return (num / 1e9).toFixed(1) + 'B';
                if (num >= 1e6) return (num / 1e6).toFixed(0) + 'M';
                return num.toLocaleString();
            };

            const isPlus = data.change_pct >= 0;
            const changeColor = isPlus ? 'text-red-400' : 'text-blue-400';
            const changeSign = isPlus ? 'â–²' : 'â–¼';

            let tierClass = 'text-gray-400 border-gray-600 bg-gray-700/20';
            if (data.tier === 1) tierClass = 'text-[#0093ff] border-[#0093ff] bg-[#0093ff]/10';
            else if (data.tier === 2) tierClass = 'text-[#00bba3] border-[#00bba3] bg-[#00bba3]/10';
            else if (data.tier === 3) tierClass = 'text-[#ffb900] border-[#ffb900] bg-[#ffb900]/10';
            else if (data.tier === 4) tierClass = 'text-[#9aa4af] border-[#9aa4af] bg-[#9aa4af]/10';
            else if (data.tier === 5) tierClass = 'text-[#a07557] border-[#a07557] bg-[#a07557]/10';

            const tierBadge = `<span class="px-2 py-0.5 text-sm font-bold rounded border ${tierClass}">${data.tier} TIER</span>`;

            const stats = data.stats_bar || { trend: 0, volume: 0, momentum: 0, impact: 0 };
            const signals = (data.signals || []).map(s => {
                if (s === "RSI_Overbought") return `<span class="text-rose-400 font-bold ml-1">RSI ê³¼ì—´ê¶Œ</span>`;
                if (s === "MACD_GoldenCross") return `<span class="text-amber-400 font-bold ml-1">MACD Golden Cross</span>`;
                return s;
            }).join(', ');

            // --- Extract Consensus HTML Generation Logic ---
            const consensusHtml = (() => {
                const cons = data.consensus;
                // Check if consensus exists AND has valid target_price data
                if (!cons || !cons.target_price) {
                    return `
                        <div class="flex items-center justify-between mb-4">
                            <div class="text-gray-400 text-xs font-bold uppercase tracking-wider">Wall St. Consensus</div>
                            <div class="text-xs text-gray-500">ë°ì´í„° ì—†ìŒ</div>
                        </div>
                        <div class="text-center text-gray-500 text-sm py-4">
                            ì „ë¬¸ê°€ ì˜ê²¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </div>
                    `;
                }

                const current = data.current_price;
                const target = cons.target_price.mean;
                const low = cons.target_price.low;
                const high = cons.target_price.high;
                const score = cons.recommendation ? cons.recommendation.score : null;
                const status = cons.recommendation ? cons.recommendation.status : null;

                const upside = ((target - current) / current * 100).toFixed(1);
                const isUpsidePositive = upside >= 0;
                const upsideColor = isUpsidePositive ? 'text-green-400' : 'text-red-400';
                const upsideSign = isUpsidePositive ? '+' : '';

                const valMin = Math.min(low, current, target) * 0.95;
                const valMax = Math.max(high, current, target) * 1.05;
                const fullRange = valMax - valMin;

                const getPos = (val) => ((val - valMin) / fullRange * 100);

                const p_low = getPos(low);
                const p_high = getPos(high);
                const p_target = getPos(target);
                const p_current = getPos(current);

                return `
                    <div class="text-sm font-bold text-gray-200 mb-4 border-b border-gray-700 pb-2 flex items-center gap-2">
                        <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        ì›”ìŠ¤íŠ¸ë¦¬íŠ¸ ì‹œì¥ ì˜ˆìƒì¹˜(ì „ë§ì¹˜)
                    </div>
                    <div class="flex justify-between items-end mb-6">
                        <div>
                            ${status ? `
                            <div class="text-2xl font-bold text-white flex items-center gap-2">
                                ${status}
                                <span class="text-xs bg-blue-600 text-white px-2 py-0.5 rounded">${score} / 5.0</span>
                            </div>
                            ` : `
                            <div class="text-sm text-gray-400">íˆ¬ìì˜ê²¬ ì—†ìŒ</div>
                            `}
                        </div>
                        <div class="text-right">
                            <div class="text-gray-400 text-xs">ìƒìŠ¹ ì—¬ë ¥ (Upside)</div>
                            <div class="text-xl font-bold ${upsideColor}">${upsideSign}${upside}%</div>
                        </div>
                    </div>

                    <div class="relative w-full h-20 mt-6 select-none">
                        
                        <!-- Full Range Bar (ì „ì²´ ì˜ì—­) -->
                        <div class="absolute top-6 h-2 bg-gradient-to-r from-gray-700 via-gray-600 to-gray-700 rounded-full w-full"></div>

                        <!-- Low Price Marker (íšŒìƒ‰) -->
                        <div class="absolute top-4 flex flex-col items-center z-10" style="left: ${p_low}%; transform: translateX(-50%);">
                            <div class="h-6 w-0.5 bg-gray-500 opacity-80"></div>
                            <div class="mt-1 text-[10px] text-gray-500 font-bold">$${low.toFixed(2)}</div>
                            <div class="text-[9px] text-gray-600">Low</div>
                        </div>

                        <!-- High Price Marker (íšŒìƒ‰) -->
                        <div class="absolute top-4 flex flex-col items-center z-10" style="left: ${p_high}%; transform: translateX(-50%);">
                            <div class="h-6 w-0.5 bg-gray-500 opacity-80"></div>
                            <div class="mt-1 text-[10px] text-gray-500 font-bold">$${high.toFixed(2)}</div>
                            <div class="text-[9px] text-gray-600">High</div>
                        </div>

                        <!-- Target Price (Green Line) -->
                        <div class="absolute top-4 flex flex-col items-center group cursor-pointer z-10 transition-all duration-1000" style="left: ${p_target}%; transform: translateX(-50%);">
                            <div class="h-6 w-0.5 bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.8)]"></div>
                            <div class="mt-1 text-[10px] text-green-400 font-bold">$${target.toFixed(2)}</div>
                            <div class="text-[9px] text-gray-400">Target</div>
                        </div>

                        <!-- Current Price (White Triangle) - Moved Above -->
                        <div class="absolute -top-4 flex flex-col items-center z-20 transition-all duration-1000" style="left: ${p_current}%; transform: translateX(-50%);">
                            <div class="mb-1 px-2 py-0.5 bg-gray-600 rounded text-xs text-white font-bold border border-gray-500 shadow-lg whitespace-nowrap">
                                Now $${current}
                            </div>
                            <div class="w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-t-[8px] border-t-white drop-shadow-md"></div>
                        </div>

                    </div>
                `;
            })();

            // --- Financial Health HTML Generation (Enhanced with indicators, badges, tooltips) ---
            const financialHealthHtml = (() => {
                const fh = data.financial_health;
                if (!fh) {
                    return `
                        <div class="text-center text-gray-500 text-sm py-4">
                            ì¬ë¬´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </div>
                    `;
                }

                // Status evaluation helper
                const evaluate = (val, thresholds) => {
                    if (val === null || val === undefined || val === 0) return { color: 'text-gray-500', badge: null, badgeColor: '' };
                    if (thresholds.higherBetter) {
                        if (val >= thresholds.good) return { color: 'text-green-400', badge: thresholds.goodLabel, badgeColor: 'bg-green-500/20 text-green-400' };
                        if (val >= thresholds.warn) return { color: 'text-gray-300', badge: null, badgeColor: '' };
                        return { color: 'text-red-400', badge: thresholds.badLabel, badgeColor: 'bg-red-500/20 text-red-400' };
                    } else {
                        // Lower is better (PER, PBR, debt)
                        if (val <= thresholds.good) return { color: 'text-green-400', badge: thresholds.goodLabel, badgeColor: 'bg-green-500/20 text-green-400' };
                        if (val <= thresholds.warn) return { color: 'text-gray-300', badge: null, badgeColor: '' };
                        return { color: 'text-red-400', badge: thresholds.badLabel, badgeColor: 'bg-red-500/20 text-red-400' };
                    }
                };

                // Thresholds definition
                const thresholds = {
                    per: { good: 15, warn: 25, goodLabel: 'ì €í‰ê°€', badLabel: 'ê³ í‰ê°€', higherBetter: false, tip: '10ë°° ë¯¸ë§Œì´ë©´ ì €í‰ê°€', benchmark: 'S&P500 í‰ê·  ì•½ 20ë°°' },
                    pbr: { good: 1.5, warn: 3, goodLabel: 'ìì‚°ê°€ì¹˜â†‘', badLabel: 'ê³ í‰ê°€', higherBetter: false, tip: '1ë°° ë¯¸ë§Œì´ë©´ ìˆœìì‚°ë³´ë‹¤ ì €ë ´', benchmark: '1~3ë°°ê°€ ì¼ë°˜ì ' },
                    revenue_growth: { good: 15, warn: 0, goodLabel: 'ê³ ì„±ì¥', badLabel: 'ì—­ì„±ì¥', higherBetter: true, tip: '15% ì´ìƒì´ë©´ ê³ ì„±ì¥ ê¸°ì—…', benchmark: 'S&P500 í‰ê·  5~10%' },
                    eps_growth: { good: 20, warn: 0, goodLabel: 'ê¸‰ì„±ì¥', badLabel: 'ê°ì†Œ', higherBetter: true, tip: '20% ì´ìƒì´ë©´ ì´ìµ ê¸‰ì¦', benchmark: '10% ì´ìƒì´ë©´ ì–‘í˜¸' },
                    roe: { good: 15, warn: 8, goodLabel: 'ê³ ìˆ˜ìµ', badLabel: 'ì €íš¨ìœ¨', higherBetter: true, tip: 'ì›Œë Œ ë²„í•ì€ 15% ì´ìƒ ì„ í˜¸', benchmark: '10% ì´ìƒì´ë©´ ì–‘í˜¸' },
                    operating_margin: { good: 15, warn: 5, goodLabel: 'ë§ˆì§„ìš°ìˆ˜', badLabel: 'ì €ë§ˆì§„', higherBetter: true, tip: '15% ì´ìƒì´ë©´ íƒì›”í•œ ìˆ˜ìµì„±', benchmark: 'ì—…ì¢…ë³„ í¸ì°¨ í¼' },
                    debt_ratio: { good: 100, warn: 200, goodLabel: 'ì•ˆì •', badLabel: 'ìœ„í—˜', higherBetter: false, tip: '100% ë¯¸ë§Œì´ë©´ ì¬ì • ê±´ì „', benchmark: '200% ì´ˆê³¼ ì‹œ ì£¼ì˜' },
                    current_ratio: { good: 1.5, warn: 1, goodLabel: 'ìœ ë™ì„±â†‘', badLabel: 'ì£¼ì˜', higherBetter: true, tip: '1.5 ì´ìƒì´ë©´ ë‹¨ê¸° ìƒí™˜ ëŠ¥ë ¥ ìš°ìˆ˜', benchmark: '1 ë¯¸ë§Œì€ ìœ ë™ì„± ìœ„í—˜' }
                };

                // Format with color and badge
                const formatMetric = (key, val, suffix = '') => {
                    if (val === null || val === undefined || val === 0) return '<span class="text-gray-500">-</span>';
                    const t = thresholds[key];
                    const status = evaluate(val, t);
                    const badgeHtml = status.badge ? `<span class="ml-1 text-[9px] px-1.5 py-0.5 rounded ${status.badgeColor}">${status.badge}</span>` : '';
                    return `<span class="${status.color} font-bold">${val}${suffix}</span>${badgeHtml}`;
                };

                // Tooltip helper
                const tooltip = (key) => {
                    const t = thresholds[key];
                    return `<span class="group relative cursor-help ml-1">
                        <span class="text-gray-500 text-[10px] p-2 -m-2">â“˜</span>
                        <span class="invisible group-hover:visible absolute bottom-full left-1/2 -translate-x-1/4 mb-2 w-40 p-2 bg-gray-900 border border-gray-700 rounded text-[10px] text-gray-300 z-50 shadow-lg">
                            <div class="font-bold text-white mb-1">${t.tip}</div>
                            <div class="text-gray-400">ê¸°ì¤€: ${t.benchmark}</div>
                        </span>
                    </span>`;
                };

                return `
                    <!-- ê°€ì¹˜ í‰ê°€ -->
                    <div class="bg-[#1e1e24] rounded-lg p-4 border border-gray-700">
                        <div class="flex items-center gap-2 mb-3">
                            <svg class="w-4 h-4 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="text-sm font-bold text-gray-200">ê°€ì¹˜ í‰ê°€</span>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="text-xs text-gray-400 mb-1 flex items-center">PER${tooltip('per')}</div>
                                <div class="text-lg">${formatMetric('per', fh.per, 'ë°°')}</div>
                                <div class="text-[10px] text-gray-500 mt-1">ìˆœì´ìµì˜ ëª‡ ë°°?</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-400 mb-1 flex items-center">PBR${tooltip('pbr')}</div>
                                <div class="text-lg">${formatMetric('pbr', fh.pbr, 'ë°°')}</div>
                                <div class="text-[10px] text-gray-500 mt-1">ìˆœìì‚°ì˜ ëª‡ ë°°?</div>
                            </div>
                        </div>
                    </div>

                    <!-- ì„±ì¥ì„± -->
                    <div class="bg-[#1e1e24] rounded-lg p-4 border border-gray-700">
                        <div class="flex items-center gap-2 mb-3">
                            <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                            <span class="text-sm font-bold text-gray-200">ì„±ì¥ì„±</span>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="text-xs text-gray-400 mb-1 flex items-center">ë§¤ì¶œì„±ì¥ë¥ ${tooltip('revenue_growth')}</div>
                                <div class="text-lg">${formatMetric('revenue_growth', fh.revenue_growth, '%')}</div>
                                <div class="text-[10px] text-gray-500 mt-1">ë§¤ì¶œ ì¦ê°€ìœ¨</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-400 mb-1 flex items-center">EPSì„±ì¥ë¥ ${tooltip('eps_growth')}</div>
                                <div class="text-lg">${formatMetric('eps_growth', fh.eps_growth, '%')}</div>
                                <div class="text-[10px] text-gray-500 mt-1">ì£¼ë‹¹ìˆœì´ìµ ì¦ê°€ìœ¨</div>
                            </div>
                        </div>
                    </div>

                    <!-- ìˆ˜ìµì„± -->
                    <div class="bg-[#1e1e24] rounded-lg p-4 border border-gray-700">
                        <div class="flex items-center gap-2 mb-3">
                            <svg class="w-4 h-4 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                            </svg>
                            <span class="text-sm font-bold text-gray-200">ìˆ˜ìµì„±</span>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="text-xs text-gray-400 mb-1 flex items-center">ROE${tooltip('roe')}</div>
                                <div class="text-lg">${formatMetric('roe', fh.roe, '%')}</div>
                                <div class="text-[10px] text-gray-500 mt-1">ìê¸°ìë³¸ì´ìµë¥ </div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-400 mb-1 flex items-center">ì˜ì—…ì´ìµë¥ ${tooltip('operating_margin')}</div>
                                <div class="text-lg">${formatMetric('operating_margin', fh.operating_margin, '%')}</div>
                                <div class="text-[10px] text-gray-500 mt-1">ìˆœìˆ˜ ì˜ì—… ë§ˆì§„</div>
                            </div>
                        </div>
                    </div>

                    <!-- ì•ˆì •ì„± -->
                    <div class="bg-[#1e1e24] rounded-lg p-4 border border-gray-700">
                        <div class="flex items-center gap-2 mb-3">
                            <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                            <span class="text-sm font-bold text-gray-200">ì•ˆì •ì„±</span>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="text-xs text-gray-400 mb-1 flex items-center">ë¶€ì±„ë¹„ìœ¨${tooltip('debt_ratio')}</div>
                                <div class="text-lg">${formatMetric('debt_ratio', fh.debt_ratio, '%')}</div>
                                <div class="text-[10px] text-gray-500 mt-1">ìë³¸ ëŒ€ë¹„ ë¶€ì±„</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-400 mb-1 flex items-center">ìœ ë™ë¹„ìœ¨${tooltip('current_ratio')}</div>
                                <div class="text-lg">${formatMetric('current_ratio', fh.current_ratio, '')}</div>
                                <div class="text-[10px] text-gray-500 mt-1">ë‹¨ê¸° ìƒí™˜ ëŠ¥ë ¥</div>
                            </div>
                        </div>
                    </div>
                `;
            })();

            const html = `
                <!-- Breadcrumb Navigation -->
                <nav class="text-xs text-gray-500 mb-3 flex items-center gap-1" aria-label="Breadcrumb">
                    <a href="/" class="hover:text-gray-300 transition">í™ˆ</a>
                    <span class="text-gray-600">â€º</span>
                    <a href="/sector/${SECTOR_SLUGS[data.sector]}" class="hover:text-gray-300 transition">${data.sector}</a>
                    <span class="text-gray-600">â€º</span>
                    <span class="text-gray-400">${data.ticker}</span>
                </nav>

                <section class="flex flex-row justify-between items-start md:items-end mb-6 gap-4">
                    <div class="flex items-center gap-4 flex-1">
                        <img src="https://financialmodelingprep.com/image-stock/${data.ticker.replace('.', '-')}.png" 
                             alt="${data.name}(${data.ticker}) ì£¼ì‹ ë¡œê³  - ${data.sector} ì„¹í„°"
                             loading="lazy"
                             onerror="this.src='https://ui-avatars.com/api/?name=${data.ticker}&background=5383e8&color=fff&size=256'" 
                             style="filter: invert(1) hue-rotate(180deg);" class="w-16 h-16 rounded-lg shadow-lg object-contain">
                            <div class="w-full">
                                <div class="flex items-center gap-2 mb-0.5">
                                    <h1 class="text-2xl md:text-3xl font-bold text-white tracking-tight break-keep mr-1">${data.name}</h1>
                                    <div id="favoriteContainer" class="cursor-pointer pt-1 shrink-0"></div>
                                </div>
                                
                                <div class="flex justify-between items-start w-full gap-4">
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-lg font-bold text-gray-400 tracking-wider">${data.ticker}</span>
                                            ${tierBadge}
                                        </div>
                                        <a href="/sector/${SECTOR_SLUGS[data.sector]}" class="inline-block px-2 py-1 bg-gray-600 text-gray-200 rounded text-xs font-bold hover:bg-gray-500 transition-colors mt-1 hover:text-white hover:no-underline">${data.sector}</a>
                                    </div>

                                    <!-- Mobile Price Block -->
                                    <div class="text-right md:hidden">
                                        <div class="text-2xl font-bold font-mono">$${data.current_price}</div>
                                        <div class="${changeColor} font-bold text-sm flex items-center justify-end gap-1">
                                            ${isPlus ? 'â–²' : ''} ${data.change_pct}%
                                        </div>
                                        <div class="text-[10px] text-gray-400 font-bold mt-0.5 tracking-wider">
                                            ${formatMarketCap(data.market_cap)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Desktop Price Block -->
                    <div class="text-right hidden md:block">
                        <div class="text-4xl font-bold font-mono">$${data.current_price}</div>
                        <div class="${changeColor} font-bold text-lg flex items-center justify-end gap-1">
                            ${isPlus ? 'â–²' : ''} ${data.change_pct}% <span class="text-xs text-gray-500 font-normal">Today</span>
                        </div>
                        <div class="text-[11px] text-gray-500 font-bold mt-1 tracking-wider">
                           ${formatMarketCap(data.market_cap)}
                        </div>
                    </div>
                </section>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <div class="lg:col-span-2 flex flex-col gap-6 lg:gap-4">
                        
                        <div id="tv_chart_container" class="bg-[#282830] rounded-xl border border-gray-800 h-[500px] relative overflow-hidden group"></div>

                        <!-- Wall St. Consensus (Desktop Only) -->
                        <div class="bg-[#282830] rounded-xl border border-gray-800 p-6 hidden lg:block">
                            ${consensusHtml}
                        </div>

                        <!-- Financial Health (Desktop Only) -->
                        <div class="bg-[#282830] rounded-xl border border-gray-800 p-6 hidden lg:block">
                            <h3 class="flex items-center gap-2 text-sm font-bold text-gray-200 mb-4 border-b border-gray-700 pb-2">
                                <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                </svg>
                                ì¬ë¬´ ê±´ì „ì„± ì ê²€
                            </h3>
                            <div class="space-y-3">
                                ${financialHealthHtml}
                            </div>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                           </div>
                    </div>

                    <div class="flex flex-col gap-4">
                        
                        <div class="bg-[#282830] rounded-xl border border-gray-700 p-6 relative overflow-hidden shadow-2xl">
                            
                            <h2 class="text-sm font-bold text-gray-200 mb-4 border-b border-gray-700 pb-2 flex items-center gap-2">
                                <svg class="w-4 h-4 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                                </svg>
                                ë‚˜ìŠ¤í”½ ì ìˆ˜ ë¶„ì„
                            </h2>
                            
                            <div class="flex items-end gap-2 mb-6">
                                <span class="text-5xl font-extrabold text-[#5383e8] tracking-tighter">${data.final_score}</span>
                                <span class="text-lg font-bold text-gray-500 mb-2">/ 100</span>
                            </div>
                        
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between text-xs mb-1.5">
                                        <span class="text-gray-300 font-bold">ğŸ“ˆ Fundamentals (ì‹¤ì /ì„±ì¥)</span>
                                        <span class="text-blue-400 font-bold">${stats.fundamentals}%</span>
                                    </div>
                                    <div class="w-full bg-gray-700 h-2 rounded-full overflow-hidden">
                                        <div class="stat-bar bg-gradient-to-r from-blue-600 to-blue-400 h-full shadow-[0_0_10px_rgba(59,130,246,0.5)]" style="--width: ${stats.fundamentals}%"></div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div class="flex justify-between text-xs mb-1.5">
                                        <span class="text-gray-300 font-bold">ğŸ’° Value (ê°€ì¹˜í‰ê°€)</span>
                                        <span class="text-amber-400 font-bold">${stats.value}%</span>
                                    </div>
                                    <div class="w-full bg-gray-700 h-2 rounded-full overflow-hidden">
                                        <div class="stat-bar bg-gradient-to-r from-amber-600 to-amber-400 h-full shadow-[0_0_10px_rgba(245,158,11,0.5)]" style="--width: ${stats.value}%"></div>
                                    </div>
                                </div>

                                <div>
                                    <div class="flex justify-between text-xs mb-1.5">
                                        <span class="text-gray-300 font-bold">ğŸš€ Momentum (ìƒìŠ¹íƒ„ë ¥)</span>
                                        <span class="text-rose-400 font-bold">${stats.momentum}%</span>
                                    </div>
                                    <div class="w-full bg-gray-700 h-2 rounded-full overflow-hidden">
                                        <div class="stat-bar bg-gradient-to-r from-rose-600 to-rose-400 h-full shadow-[0_0_10px_rgba(244,63,94,0.5)]" style="--width: ${stats.momentum}%"></div>
                                    </div>
                                </div>

                                <div>
                                    <div class="flex justify-between text-xs mb-1.5">
                                        <span class="text-gray-300 font-bold">ğŸ›¡ï¸ Stability (ì¬ë¬´ì•ˆì •)</span>
                                        <span class="text-cyan-400 font-bold">${stats.stability}%</span>
                                    </div>
                                    <div class="w-full bg-gray-700 h-2 rounded-full overflow-hidden">
                                        <div class="stat-bar bg-gradient-to-r from-cyan-600 to-cyan-400 h-full shadow-[0_0_10px_rgba(34,211,238,0.5)]" style="--width: ${stats.stability}%"></div>
                                    </div>
                                </div>

                                <div>
                                    <div class="flex justify-between text-xs mb-1.5">
                                        <span class="text-gray-300 font-bold">âš¡ Risk (ì €ë³€ë™ì„±)</span>
                                        <span class="text-purple-400 font-bold">${stats.risk}%</span>
                                    </div>
                                    <div class="w-full bg-gray-700 h-2 rounded-full overflow-hidden">
                                        <div class="stat-bar bg-gradient-to-r from-purple-600 to-purple-400 h-full shadow-[0_0_10px_rgba(168,85,247,0.5)]" style="--width: ${stats.risk}%"></div>
                                    </div>
                                </div>

                                <div>
                                    <div class="flex justify-between text-xs mb-1.5">
                                        <span class="text-gray-300 font-bold">ğŸŒ Consensus (ì›”ê°€ì „ë§)</span>
                                        <span class="text-green-400 font-bold">${stats.consensus}%</span>
                                    </div>
                                    <div class="w-full bg-gray-700 h-2 rounded-full overflow-hidden">
                                        <div class="stat-bar bg-gradient-to-r from-green-600 to-green-400 h-full shadow-[0_0_10px_rgba(34,197,94,0.5)]" style="--width: ${stats.consensus}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Wall St. Consensus (Mobile Only) -->
                        <div class="bg-[#282830] rounded-xl border border-gray-800 p-6 block lg:hidden">
                            ${consensusHtml}
                        </div>

                        <!-- Technical Analysis -->
                        <div class="bg-[#282830] rounded-xl border border-gray-800 p-5">
                            <h3 class="flex items-center gap-2 text-sm font-bold text-gray-200 mb-4 border-b border-gray-700 pb-2">
                                <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                ê¸°ìˆ ì  ë¶„ì„
                            </h3>
                            <div class="space-y-4">
                                ${(() => {
                    const ta = data.technical_analysis || {};
                    let html = '';

                    // 1. Candle Pattern
                    const cp = ta.candle_pattern;
                    if (cp) {
                        const imgPath = '/images/candle_patterns/' + cp.pattern + '.png';
                        html += `
                                            <div class="bg-[#1e1e24] rounded-lg p-3 border border-gray-700">
                                                <div class="text-[10px] text-gray-500 uppercase tracking-wider mb-2">ìº”ë“¤ íŒ¨í„´</div>
                                                <div class="flex items-center gap-3">
                                                    <img src="${imgPath}" alt="${cp.name_kr}" class="w-12 h-12 object-contain" onerror="this.style.display='none'">
                                                    <div>
                                                        <div class="text-sm font-bold ${cp.signal === 'bullish' ? 'text-green-400' : 'text-red-400'}">${cp.name_kr}</div>
                                                        <div class="text-[10px] text-gray-500">${cp.desc} (${cp.date})</div>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                    } else {
                        html += `
                                            <div class="bg-[#1e1e24] rounded-lg p-3 border border-gray-700">
                                                <div class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">ìº”ë“¤ íŒ¨í„´</div>
                                                <div class="text-xs text-gray-500">ìµœê·¼ 5ì¼ ë‚´ íŠ¹ì´ íŒ¨í„´ ì—†ìŒ</div>
                                            </div>
                                        `;
                    }

                    // 2. RSI (Gauge Chart Style)
                    const rsi = ta.rsi || { value: 50, status: 'neutral' };
                    // Color logic: Overbought=Red, Oversold=Blue, Others=Gray
                    const rsiColor = rsi.status === 'overbought' ? 'text-red-400' :
                        rsi.status === 'oversold' ? 'text-blue-400' : 'text-gray-400';
                    const rsiLabel = rsi.status === 'overbought' ? 'ê³¼ë§¤ìˆ˜' :
                        rsi.status === 'oversold' ? 'ê³¼ë§¤ë„' :
                            rsi.status === 'bullish' ? 'ê°•ì„¸' : 'ì•½ì„¸';

                    html += `
                                        <div class="bg-[#1e1e24] rounded-lg p-3 border border-gray-700">
                                            <div class="flex justify-between items-center mb-3">
                                                <div class="text-[10px] text-gray-500 uppercase tracking-wider">RSI (14)</div>
                                                <div class="${rsiColor} text-xs font-bold">${rsiLabel}</div>
                                            </div>
                                            <div class="relative">
                                                <!-- RSI Gauge Background with zones -->
                                                <div class="h-3 rounded-full overflow-hidden flex">
                                                    <div class="w-[30%] bg-gradient-to-r from-blue-600 to-blue-500"></div>
                                                    <div class="w-[40%] bg-gradient-to-r from-blue-500 via-gray-600 to-red-500"></div>
                                                    <div class="w-[30%] bg-gradient-to-r from-red-500 to-red-600"></div>
                                                </div>
                                                <!-- RSI Marker -->
                                                <div class="absolute top-0 h-3 flex items-center" style="left: ${rsi.value}%; transform: translateX(-50%);">
                                                    <div class="w-1 h-5 bg-white rounded shadow-lg shadow-white/50"></div>
                                                </div>
                                                <!-- Zone Labels -->
                                                <div class="flex justify-between text-[8px] text-gray-600 mt-1">
                                                    <span>0</span>
                                                    <span class="text-blue-500">30</span>
                                                    <span class="text-gray-400">50</span>
                                                    <span class="text-red-500">70</span>
                                                    <span>100</span>
                                                </div>
                                            </div>
                                            <div class="text-center mt-2">
                                                <span class="text-2xl font-bold ${rsiColor}">${rsi.value}</span>
                                            </div>
                                        </div>
                                    `;

                    // 3. Volume
                    const vol = ta.volume || { pct_change: 0, status: 'normal' };
                    // Color logic: Rise=Red, Fall=Blue
                    const volColor = vol.pct_change >= 0 ? 'text-red-400' : 'text-blue-400';
                    const volSign = vol.pct_change >= 0 ? '+' : '';

                    html += `
                                        <div class="bg-[#1e1e24] rounded-lg p-3 border border-gray-700">
                                            <div class="text-[10px] text-gray-500 uppercase tracking-wider mb-2">ê±°ë˜ëŸ‰ <span class="normal-case">(ì „ì¼)</span></div>
                                            <div class="flex items-center gap-2">
                                                <div class="${volColor} text-sm font-bold">í‰ê·  ëŒ€ë¹„ ${volSign}${vol.pct_change}%</div>
                                            </div>
                                        </div>
                                    `;

                    return html;
                })()}
                            </div>
                        </div>

                        <!-- Financial Health (Mobile Only) -->
                        <div class="bg-[#282830] rounded-xl border border-gray-800 p-5 block lg:hidden">
                            <h3 class="flex items-center gap-2 text-sm font-bold text-gray-200 mb-4 border-b border-gray-700 pb-2">
                                <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                </svg>
                                ì¬ë¬´ ê±´ì „ì„± ì ê²€
                            </h3>
                            <div class="space-y-3">
                                ${financialHealthHtml}
                            </div>
                        </div>

                        <!-- 3. Investment Calendar HTML Generation -->
                        ${(() => {
                    const cal = data.calendar || {};
                    const earningsDate = cal.next_earnings || 'ë¯¸ì •';
                    const exDivDate = cal.ex_dividend_date || '-';
                    const payDate = cal.dividend_payment_date || '-';
                    const divAmt = cal.dividend_amount ? `$${cal.dividend_amount.toFixed(2)}` : '-';

                    // Earnings Logic
                    let earningsAlert = '';
                    let earningsDday = '';
                    if (earningsDate !== 'ë¯¸ì •') {
                        const todayMs = new Date().setHours(0, 0, 0, 0);
                        const targetMs = new Date(earningsDate).setHours(0, 0, 0, 0);
                        const diffDays = Math.ceil((targetMs - todayMs) / (1000 * 60 * 60 * 24));

                        if (diffDays >= 0 && diffDays <= 7) {
                            earningsDday = `<span class="text-orange-400 font-bold ml-2">D-${diffDays}</span>`;
                            earningsAlert = 'ğŸ””';
                        } else if (diffDays > 7 && diffDays <= 14) {
                            earningsDday = `<span class="text-gray-400 ml-2">D-${diffDays}</span>`;
                        } else if (diffDays < 0) {
                            earningsDday = `<span class="text-gray-600 ml-2 text-[10px]">(ì¢…ë£Œ)</span>`;
                        }
                    }

                    // Dividend Logic Helper
                    const getDateStatus = (dateStr) => {
                        if (!dateStr || dateStr === '-') return '';
                        const todayMs = new Date().setHours(0, 0, 0, 0);
                        const targetMs = new Date(dateStr).setHours(0, 0, 0, 0);
                        return targetMs < todayMs ? '<span class="text-gray-500 text-[10px] ml-1">(ì§€ë‚¬ìŒ)</span>' : '<span class="text-blue-400 text-[10px] ml-1">(ì˜ˆì •)</span>';
                    };

                    return `
                                <div class="bg-[#282830] rounded-xl border border-gray-800 p-5">
                                    <h4 class="text-sm font-bold text-gray-200 mb-4 border-b border-gray-700 pb-2 flex items-center gap-2">
                                        <svg class="w-4 h-4 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                        íˆ¬ì ìº˜ë¦°ë”
                                    </h4>
                                    <div class="space-y-4">
                                        <!-- Earnings -->
                                        <div>
                                            ${(() => {
                            // 1. Earnings Logic
                            let nextHtml = '';
                            if (cal.next_earnings) {
                                const todayMs = new Date().setHours(0, 0, 0, 0);
                                const nextDate = new Date(cal.next_earnings);
                                const nextMs = nextDate.setHours(0, 0, 0, 0);
                                const diffDays = Math.ceil((nextMs - todayMs) / (1000 * 60 * 60 * 24));

                                let dDay = '';
                                let alert = '';
                                const isFuture = diffDays >= 0;

                                if (isFuture) {
                                    if (diffDays <= 7) {
                                        dDay = `<span class="text-orange-400 font-bold ml-2">D-${diffDays}</span>`;
                                        alert = 'ğŸ””';
                                    } else if (diffDays <= 14) {
                                        dDay = `<span class="text-gray-400 ml-2">D-${diffDays}</span>`;
                                    }

                                    nextHtml = `
                                        <div class="text-xs text-gray-400 mb-1 flex items-center">
                                            ë‹¤ìŒ ì‹¤ì  ë°œí‘œ ${dDay}
                                        </div>
                                        <div class="text-sm font-bold text-gray-200 flex items-center gap-2">
                                            ${cal.next_earnings} ${alert}
                                        </div>
                                    `;
                                } else {
                                    // Date passed
                                    nextHtml = `
                                        <div class="text-xs text-gray-400 mb-1 flex items-center">
                                            ì§ì „ ì‹¤ì  ë°œí‘œ <span class="text-gray-600 ml-2 text-[10px]">(ì¢…ë£Œ)</span>
                                        </div>
                                        <div class="text-sm font-bold text-gray-500 flex items-center gap-2">
                                            ${cal.next_earnings}
                                        </div>
                                    `;
                                }

                            } else {
                                nextHtml = `
                                        <div class="text-xs text-gray-400 mb-1">ì‹¤ì  ë°œí‘œ</div>
                                        <div class="text-sm text-gray-500">ì¼ì • ë¯¸ì •</div>
                                    `;
                            }

                            // 2. Past Earnings Logic (Surprise)
                            let pastHtml = '';
                            if (cal.last_earnings_date && cal.last_surprise !== undefined) {
                                const isBeat = cal.last_surprise > 0;
                                const color = isBeat ? 'text-green-400' : 'text-red-400';
                                const label = isBeat ? 'ì–´ë‹ ì„œí”„ë¼ì´ì¦ˆ' : 'ì–´ë‹ ì‡¼í¬';
                                const sign = isBeat ? '+' : '';

                                pastHtml = `
                                                        <div class="mt-3 pt-3 border-t border-gray-700/50">
                                                            <div class="text-xs text-gray-400 mb-1 flex justify-between">
                                                                <span>ì§ì „ ì‹¤ì  (${cal.last_earnings_date})</span>
                                                                <span class="${color} font-bold text-[10px] bg-gray-700/50 px-1.5 rounded">${label}</span>
                                                            </div>
                                                            <div class="flex justify-between items-end">
                                                                <div class="text-[10px] text-gray-500">
                                                                    ì˜ˆìƒ ${cal.last_eps_est ? Number(cal.last_eps_est).toFixed(2) : '-'} / ì‹¤ì œ <span class="text-gray-200 font-bold">${Number(cal.last_eps_act).toFixed(2)}</span>
                                                                </div>
                                                                <div class="${color} font-bold text-sm">
                                                                    ${sign}${Number(cal.last_surprise).toFixed(2)}%
                                                                </div>
                                                            </div>
                                                        </div>
                                                    `;
                            }

                            return nextHtml + pastHtml;
                        })()}
                                        </div>

                                        <div class="w-full h-px bg-gray-700/50 my-2"></div>

                                        <!-- Dividend -->
                                        ${(() => {
                            const exDate = cal.ex_dividend_date;
                            const payDate = cal.dividend_payment_date;
                            const amount = cal.dividend_amount ? `$${cal.dividend_amount.toFixed(2)}` : '-';

                            if (!exDate || exDate === '-') {
                                return `
                                                    <div>
                                                        <div class="text-xs text-gray-400 mb-2">ë°°ë‹¹</div>
                                                        <div class="text-xs text-gray-500 text-center py-2">ë°°ë‹¹ ì •ë³´ ì—†ìŒ</div>
                                                    </div>
                                                `;
                            }

                            const todayMs = new Date().setHours(0, 0, 0, 0);
                            const targetExMs = new Date(exDate).setHours(0, 0, 0, 0);
                            const isExFuture = targetExMs >= todayMs;

                            let label = '';
                            let statusBadge = '';
                            let dateColor = '';

                            if (isExFuture) {
                                // Case 1: Before Ex-Dividend Date
                                label = 'ë‹¤ìŒ ë°°ë‹¹ë½ì¼';
                                statusBadge = `<span class="text-blue-400 text-[10px] ml-1 bg-blue-500/10 px-1 rounded border border-blue-500/30">ì˜ˆì •</span>`;
                                dateColor = 'text-gray-200';
                            } else {
                                // Case 2: After Ex-Dividend Date
                                label = 'ìµœê·¼ ë°°ë‹¹ë½ì¼';
                                dateColor = 'text-gray-500';

                                // Check Payment Status
                                let isPayFuture = false;
                                if (payDate && payDate !== '-') {
                                    const targetPayMs = new Date(payDate).setHours(0, 0, 0, 0);
                                    isPayFuture = targetPayMs >= todayMs;
                                }

                                if (isPayFuture) {
                                    // Ex-Div passed, but Payment is future
                                    statusBadge = `<span class="text-amber-400 text-[10px] ml-1 bg-amber-500/10 px-1 rounded border border-amber-500/30">ì§€ê¸‰ ì˜ˆì •</span>`;
                                } else {
                                    // Payment also passed
                                    statusBadge = `<span class="text-gray-500 text-[10px] ml-1 bg-gray-700/50 px-1 rounded">ì§€ê¸‰ì™„ë£Œ</span>`;
                                }
                            }

                            const payDateStyle = (payDate && new Date(payDate).setHours(0, 0, 0, 0) >= todayMs) ? 'text-amber-400 font-bold' : 'text-gray-500';

                            return `
                                                <div>
                                                    <div class="text-xs text-gray-400 mb-2">ë°°ë‹¹</div>
                                                    <div class="space-y-4">
                                                        <div class="flex justify-between items-start">
                                                            <div>
                                                                <div class="text-[10px] text-gray-500 mb-0.5 flex items-center">
                                                                    ${label} ${statusBadge}
                                                                </div>
                                                                <div class="text-sm font-bold ${dateColor}">
                                                                    ${exDate}
                                                                </div>
                                                            </div>
                                                            <div class="text-right">
                                                                <div class="text-[10px] text-gray-500 mb-0.5">ë°°ë‹¹ê¸ˆ (1ì£¼ë‹¹)</div>
                                                                <div class="text-sm font-bold text-gray-200">${amount}</div>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="flex justify-between items-center text-[10px] text-gray-500 bg-gray-800/50 p-2 rounded">
                                                            <div class="flex gap-2">
                                                                <span>ì§€ê¸‰ì¼: <span class="${payDateStyle}">${payDate || '-'}</span></span>
                                                            </div>
                                                            <div>
                                                                ìˆ˜ìµë¥ : <span class="text-gray-300 font-bold">${cal.dividend_yield ? cal.dividend_yield + '%' : '-'}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                        })()}
                                    </div>
                                </div>
                            `;
                })()}

                        <div class="bg-[#23232a] rounded-xl border border-gray-800 p-5">
                            <!-- Header with Segmented Control -->
                            <div class="flex items-center justify-between mb-4 border-b border-gray-700 pb-3">
                                <h4 class="text-sm font-bold text-gray-200 flex items-center gap-2">
                                    <svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                    ê´€ë ¨ ì¢…ëª©
                                </h4>
                                <!-- iOS Style Pill Tabs -->
                                <div class="flex bg-gray-700/50 rounded-lg p-0.5">
                                    <button id="tabSectorLeader" onclick="switchRelatedTab('sector')" 
                                            class="px-2.5 py-1 text-[10px] font-bold rounded-md transition-all bg-[#5383e8] text-white">
                                        ì„¹í„° TOP3
                                    </button>
                                    <button id="tabSimilarScore" onclick="switchRelatedTab('similar')"
                                            class="px-2.5 py-1 text-[10px] font-bold rounded-md transition-all text-gray-400 hover:text-gray-200">
                                        ìœ ì‚¬ ì ìˆ˜
                                    </button>
                                </div>
                            </div>
                            
                            <!-- SEO: ë‘ ë¦¬ìŠ¤íŠ¸ ëª¨ë‘ HTMLì— ë Œë”ë§ (CSSë¡œ í† ê¸€) -->
                            <!-- Sector Leaders List -->
                            <div id="sectorLeaderList" class="space-y-3">
                                ${(data.related_peers || []).map(p => {
                    const peerData = allData.find(d => d.ticker === p.ticker) || { name: p.ticker };
                    return `
                                        <a href="/stock/${p.ticker}" class="flex justify-between items-center border-b border-gray-800 pb-2 cursor-pointer hover:bg-gray-800 transition p-2 rounded group block text-inherit hover:no-underline">
                                            <div class="flex items-center gap-3">
                                                <div class="w-10 h-10 rounded flex items-center justify-center p-0.5 shrink-0 overflow-hidden">
                                                    <img src="https://financialmodelingprep.com/image-stock/${p.ticker.replace('.', '-')}.png" 
                                                         alt="${peerData.name}(${p.ticker}) ê´€ë ¨ì£¼"
                                                         loading="lazy"
                                                         onerror="this.src='https://ui-avatars.com/api/?name=${p.ticker}&background=5383e8&color=fff&size=128'" 
                                                         style="filter: invert(1) hue-rotate(180deg);" class="w-full h-full object-contain">
                                                </div>
                                                <div>
                                                    <div class="font-bold text-gray-200 text-sm group-hover:text-blue-400 transition">${peerData.name}</div>
                                                    <div class="text-xs text-gray-500 font-medium">${p.ticker}</div>
                                                </div>
                                            </div>
                                            <span class="${p.change_pct >= 0 ? 'text-red-400' : 'text-blue-400'} font-mono text-sm font-bold bg-[#1c1c1f] px-2 py-1 rounded">${p.change_pct > 0 ? '+' : ''}${p.change_pct}%</span>
                                        </a>
                                    `;
                }).join('')}
                                ${(data.related_peers || []).length === 0 ? '<div class="text-xs text-gray-600">ê´€ë ¨ ì¢…ëª© ì—†ìŒ</div>' : ''}
                            </div>
                            
                            <!-- Similar Score List (Hidden by default, but in HTML for SEO) -->
                            <div id="similarScoreList" class="space-y-3 hidden">
                                ${(data.similar_score_peers || []).map(p => {
                    const peerData = allData.find(d => d.ticker === p.ticker) || { name: p.ticker };
                    return `
                                        <a href="/stock/${p.ticker}" class="flex justify-between items-center border-b border-gray-800 pb-2 cursor-pointer hover:bg-gray-800 transition p-2 rounded group block text-inherit hover:no-underline">
                                            <div class="flex items-center gap-3">
                                                <div class="w-10 h-10 rounded flex items-center justify-center p-0.5 shrink-0 overflow-hidden">
                                                    <img src="https://financialmodelingprep.com/image-stock/${p.ticker.replace('.', '-')}.png" 
                                                         alt="${peerData.name}(${p.ticker}) ìœ ì‚¬ì ìˆ˜"
                                                         loading="lazy"
                                                         onerror="this.src='https://ui-avatars.com/api/?name=${p.ticker}&background=5383e8&color=fff&size=128'" 
                                                         style="filter: invert(1) hue-rotate(180deg);" class="w-full h-full object-contain">
                                                </div>
                                                <div>
                                                    <div class="font-bold text-gray-200 text-sm group-hover:text-blue-400 transition">${peerData.name}</div>
                                                    <div class="text-xs text-gray-500 font-medium">${p.ticker}</div>
                                                </div>
                                            </div>
                                            <span class="${p.change_pct >= 0 ? 'text-red-400' : 'text-blue-400'} font-mono text-sm font-bold bg-[#1c1c1f] px-2 py-1 rounded">${p.change_pct > 0 ? '+' : ''}${p.change_pct}%</span>
                                        </a>
                                    `;
                }).join('')}
                                ${(data.similar_score_peers || []).length === 0 ? '<div class="text-xs text-gray-600">ìœ ì‚¬ ì ìˆ˜ ì¢…ëª© ì—†ìŒ</div>' : ''}
                            </div>
                        </div>

                        <!-- FAQ Section -->
                        <div id="faqSection"></div> 
                    </div>
                </div>
            `;

            document.getElementById('mainContent').innerHTML = html;

            // [SEO] Render Dynamic FAQ
            renderFAQ(data);

            // Initialize TradingView Widget
            if (window.TradingView) {
                new TradingView.widget({
                    "autosize": true,
                    "symbol": (data.exchange ? data.exchange + ":" : "") + data.ticker,
                    "interval": "D",
                    "timezone": "Etc/UTC",
                    "theme": "dark",
                    "style": "1",
                    "locale": "en",
                    "enable_publishing": false,
                    "allow_symbol_change": true,
                    "container_id": "tv_chart_container",
                    "studies": ["BB@tv-basicstudies"]
                });
            }
        }

        // Tab switching for Related Stocks (SEO-friendly: CSS toggle only)
        function switchRelatedTab(type) {
            const sectorList = document.getElementById('sectorLeaderList');
            const similarList = document.getElementById('similarScoreList');
            const tabSector = document.getElementById('tabSectorLeader');
            const tabSimilar = document.getElementById('tabSimilarScore');

            if (!sectorList || !similarList) return;

            if (type === 'sector') {
                sectorList.classList.remove('hidden');
                similarList.classList.add('hidden');
                tabSector.classList.add('bg-[#5383e8]', 'text-white');
                tabSector.classList.remove('text-gray-400');
                tabSimilar.classList.remove('bg-[#5383e8]', 'text-white');
                tabSimilar.classList.add('text-gray-400');
            } else {
                sectorList.classList.add('hidden');
                similarList.classList.remove('hidden');
                tabSimilar.classList.add('bg-[#5383e8]', 'text-white');
                tabSimilar.classList.remove('text-gray-400');
                tabSector.classList.remove('bg-[#5383e8]', 'text-white');
                tabSector.classList.add('text-gray-400');
            }
        }

        function renderFAQ(data) {
            const today = new Date().toISOString().split('T')[0];
            const qnaList = [];

            // 1. Investment Score
            let scoreAns = "";
            if (data.final_score >= 80) scoreAns = `íˆ¬ì ë§¤ë ¥ë„ê°€ ë§¤ìš° ë†’ìŠµë‹ˆë‹¤. í˜„ì¬ ì£¼ê°€ ìƒìŠ¹ ëª¨ë©˜í…€ê³¼ ì¬ë¬´ ê±´ì „ì„±ì´ ëª¨ë‘ ìš°ìˆ˜í•œ ìƒíƒœì…ë‹ˆë‹¤.`;
            else if (data.final_score < 40) scoreAns = `ë‹¤ì†Œ ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤. í˜„ì¬ ì£¼ê°€ ëª¨ë©˜í…€ì´ë‚˜ ì¬ë¬´ ì§€í‘œê°€ ë‹¤ì†Œ ì•½í™”ëœ ìƒíƒœì…ë‹ˆë‹¤.`;
            else scoreAns = `ë³´í†µ ìˆ˜ì¤€ì˜ ì–‘í˜¸í•œ íë¦„ì„ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤.`;

            qnaList.push({
                q: `${data.name}(${data.ticker})ì˜ í˜„ì¬ íˆ¬ì ë“±ê¸‰ê³¼ ì ìˆ˜ëŠ”?`,
                a: `${today} ê¸°ì¤€ ë‚˜ìŠ¤í”½ AI ë¶„ì„ ê²°ê³¼, ${data.name}ì€(ëŠ”) **${data.final_score}ì (${data.tier}í‹°ì–´)**ìœ¼ë¡œ ${scoreAns}`
            });

            // 2. Valuation (PER)
            let perAns = "";
            // Fix: Use data.financial_health.per
            const per = data.financial_health?.per;
            if (per) {
                if (per < 15) perAns = `ë„¤, ê·¸ë ‡ìŠµë‹ˆë‹¤. í˜„ì¬ ${data.name}ì˜ PERì€ **${per.toFixed(2)}ë°°**ë¡œ, ì‹œì¥ í‰ê·  ëŒ€ë¹„ **ì €í‰ê°€**ë˜ì–´ ìˆì–´ ê°€ê²© ë§¤ë ¥ë„ê°€ ë†’ì€ êµ¬ê°„ì…ë‹ˆë‹¤.`;
                else if (per > 50) perAns = `í˜„ì¬ ${data.name}ì˜ PERì€ **${per.toFixed(2)}ë°°**ë¡œ, ì‹œì¥ í‰ê·  ëŒ€ë¹„ ë‹¤ì†Œ **ë†’ê²Œ í‰ê°€**ë°›ê³  ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ë†’ì€ ì„±ì¥ ê¸°ëŒ€ê°ì´ ë°˜ì˜ëœ ê²°ê³¼ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
                else perAns = `í˜„ì¬ ${data.name}ì˜ PERì€ **${per.toFixed(2)}ë°°**ë¡œ, ì‹œì¥ í‰ê· ê³¼ ìœ ì‚¬í•œ **ì ì • ê°€ì¹˜** ìˆ˜ì¤€ì—ì„œ ê±°ë˜ë˜ê³  ìˆìŠµë‹ˆë‹¤.`;

                qnaList.push({
                    q: `${data.name}(${data.ticker}) ì£¼ì‹ì€ í˜„ì¬ ì €í‰ê°€ ìƒíƒœì¸ê°€ìš”? (PER ë¶„ì„)`,
                    a: perAns
                });
            } else {
                qnaList.push({
                    q: `${data.name}(${data.ticker}) ì£¼ì‹ì€ í˜„ì¬ ì €í‰ê°€ ìƒíƒœì¸ê°€ìš”? (PER ë¶„ì„)`,
                    a: `í˜„ì¬ ${data.name}ì— ëŒ€í•œ PER(ì£¼ê°€ìˆ˜ìµë¹„ìœ¨) ë°ì´í„°ê°€ ì§‘ê³„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`
                });
            }

            // 3. Technical (RSI)
            let rsiAns = "";
            // Fix: Use data.technical_analysis.rsi.value
            const rsiObj = data.technical_analysis?.rsi;
            const rsi = rsiObj ? rsiObj.value : null;

            if (rsi) {
                if (rsi > 70) rsiAns = `ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤. í˜„ì¬ RSI ì§€í‘œê°€ **${rsi.toFixed(2)}**ë¡œ **ê³¼ë§¤ìˆ˜(ê³¼ì—´)** êµ¬ê°„ì— ì§„ì…í•´ ìˆì–´, ë‹¨ê¸°ì ìœ¼ë¡œ ì£¼ê°€ê°€ ì¡°ì •ë°›ì„ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.`;
                else if (rsi < 30) rsiAns = `ë„¤, ê¸°ìˆ ì ìœ¼ë¡œ ì¢‹ì€ ê¸°íšŒì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í˜„ì¬ RSI ì§€í‘œê°€ **${rsi.toFixed(2)}**ë¡œ **ê³¼ë§¤ë„** êµ¬ê°„ì— ìˆì–´, ê¸°ìˆ ì  ë°˜ë“±ì´ ê¸°ëŒ€ë˜ëŠ” ì‹œì ì…ë‹ˆë‹¤.`;
                else rsiAns = `í˜„ì¬ ê¸°ìˆ ì  ì§€í‘œëŠ” **ì¤‘ë¦½**ì…ë‹ˆë‹¤. RSI ì§€í‘œê°€ **${rsi.toFixed(2)}**ë¡œ ì•ˆì •ì ì¸ íë¦„ì„ ë³´ì´ê³  ìˆì–´, ë¶„í•  ë§¤ìˆ˜ ê´€ì ì—ì„œ ì ‘ê·¼í•˜ê¸° ì¢‹ìŠµë‹ˆë‹¤.`;

                qnaList.push({
                    q: `ì§€ê¸ˆ ${data.name}(${data.ticker}) ì£¼ì‹ì„ ì‚¬ë„ ë ê¹Œìš”? (RSI ê¸°ìˆ ì  ë¶„ì„)`,
                    a: rsiAns
                });
            } else {
                qnaList.push({
                    q: `ì§€ê¸ˆ ${data.name}(${data.ticker}) ì£¼ì‹ì„ ì‚¬ë„ ë ê¹Œìš”? (RSI ê¸°ìˆ ì  ë¶„ì„)`,
                    a: `í˜„ì¬ ê¸°ìˆ ì  ì§€í‘œ(RSI)ë¥¼ ë¶„ì„í•  ì¶©ë¶„í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`
                });
            }

            // 4. Calendar (Fixed: Check for past dates)
            const cal = data.calendar || {};
            let calAnsParts = [];

            // A. Dividend Logic
            if (cal.dividend_yield) {
                let divMsg = `ì˜ˆìƒ ë°°ë‹¹ ìˆ˜ìµë¥ ì€ **${cal.dividend_yield}%**ì´ë©°, `;
                if (cal.ex_dividend_date && cal.ex_dividend_date !== '-') {
                    const todayMs = new Date().setHours(0, 0, 0, 0);
                    const exDateMs = new Date(cal.ex_dividend_date).setHours(0, 0, 0, 0);

                    if (exDateMs >= todayMs) {
                        divMsg += `ë‹¤ê°€ì˜¤ëŠ” ë°°ë‹¹ë½ì¼ì€ **${cal.ex_dividend_date}**ì…ë‹ˆë‹¤.`;
                    } else {
                        divMsg += `ê°€ì¥ ìµœê·¼ ë°°ë‹¹ë½ì¼ì€ **${cal.ex_dividend_date}**ì˜€ìŠµë‹ˆë‹¤.`;
                    }
                } else {
                    divMsg += `ë°°ë‹¹ë½ì¼ ì •ë³´ëŠ” ì•„ì§ ì—†ìŠµë‹ˆë‹¤.`;
                }
                calAnsParts.push(divMsg);
            }

            // B. Earnings Logic
            if (cal.next_earnings) {
                const todayMs = new Date().setHours(0, 0, 0, 0);
                const nextDocs = new Date(cal.next_earnings);
                // Check if date is valid
                if (!isNaN(nextDocs.getTime())) {
                    const nextMs = nextDocs.setHours(0, 0, 0, 0);
                    if (nextMs >= todayMs) {
                        calAnsParts.push(`ë‹¤ìŒ ì‹¤ì  ë°œí‘œëŠ” **${cal.next_earnings}**ë¡œ ì˜ˆì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`);
                    } else {
                        calAnsParts.push(`ì§ì „ ì‹¤ì  ë°œí‘œì¼ì€ **${cal.next_earnings}**ì˜€ìœ¼ë©°,`);
                        // If we have surprise data for this past date (usually in last_surprise), append it.
                        // However, cal.next_earnings might be the *just passed* one.
                        // We can just look at last_surprise generally.
                        if (cal.last_surprise) {
                            calAnsParts.push(`ì‹œì¥ ì˜ˆìƒì¹˜ ëŒ€ë¹„ **${cal.last_surprise > 0 ? 'ì–´ë‹ ì„œí”„ë¼ì´ì¦ˆ' : 'ë¯¸ìŠ¤'}(${cal.last_surprise}%)**ë¥¼ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤.`);
                        } else {
                            calAnsParts.push(`ë°œí‘œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                        }
                    }
                } else {
                    calAnsParts.push(`ë‹¤ìŒ ì‹¤ì  ë°œí‘œëŠ” **${cal.next_earnings}**ë¡œ ì˜ˆì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`);
                }
            } else if (cal.last_surprise) {
                calAnsParts.push(`ê°€ì¥ ìµœê·¼ ì‹¤ì ë°œí‘œ(${cal.last_earnings_date})ì—ì„œëŠ” ì‹œì¥ ì˜ˆìƒì¹˜ë¥¼ ìƒíšŒí•˜ëŠ” **ì–´ë‹ ì„œí”„ë¼ì´ì¦ˆ(${cal.last_surprise > 0 ? '+' : ''}${cal.last_surprise}%)**ë¥¼ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤.`);
            }

            if (calAnsParts.length > 0) {
                qnaList.push({
                    q: `${data.name}(${data.ticker})ì˜ ë‹¤ìŒ ì‹¤ì  ë°œí‘œì¼ê³¼ ë°°ë‹¹ê¸ˆì€?`,
                    a: calAnsParts.join(' ')
                });
            } else {
                qnaList.push({
                    q: `${data.name}(${data.ticker})ì˜ ë‹¤ìŒ ì‹¤ì  ë°œí‘œì¼ê³¼ ë°°ë‹¹ê¸ˆì€?`,
                    a: `í˜„ì¬ ${data.name}ì˜ í™•ì •ëœ ì‹¤ì  ë°œí‘œì¼ì´ë‚˜ ë°°ë‹¹ ì¼ì • ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.`
                });
            }

            // 5. Price & Target
            const consensus = data.consensus || {};
            // Fix: target_price might be an object {mean: ...} or number
            let tp = consensus.target_price;
            if (tp && typeof tp === 'object') tp = tp.mean;

            if (tp && data.current_price) {
                const upside = ((tp - data.current_price) / data.current_price * 100).toFixed(2);
                const upsidedown = upside > 0 ? 'ìƒìŠ¹ ì—¬ë ¥' : 'ìˆ˜ì¤€';
                qnaList.push({
                    q: `${data.name}(${data.ticker})ì˜ í˜„ì¬ ì£¼ê°€ì™€ ëª©í‘œì£¼ê°€ëŠ” ì–¼ë§ˆì¸ê°€ìš”? (ì£¼ê°€ ì „ë§)`,
                    a: `${today} ê¸°ì¤€ ${data.name}ì˜ ì£¼ê°€ëŠ” **$${data.current_price}**ì…ë‹ˆë‹¤. ì›”ìŠ¤íŠ¸ë¦¬íŠ¸ ì „ë¬¸ê°€ë“¤ì˜ í‰ê·  ëª©í‘œì£¼ê°€ëŠ” **$${tp.toFixed(2)}**ë¡œ, í˜„ì¬ê°€ ëŒ€ë¹„ ì•½ **${upside}%ì˜ ${upsidedown}**ì´ ìˆëŠ” ê²ƒìœ¼ë¡œ ë¶„ì„ë©ë‹ˆë‹¤.`
                });
            } else {
                qnaList.push({
                    q: `${data.name}(${data.ticker})ì˜ í˜„ì¬ ì£¼ê°€ì™€ ëª©í‘œì£¼ê°€ëŠ” ì–¼ë§ˆì¸ê°€ìš”? (ì£¼ê°€ ì „ë§)`,
                    a: `${data.name}ì— ëŒ€í•œ ì›”ìŠ¤íŠ¸ë¦¬íŠ¸ ì „ë¬¸ê°€ë“¤ì˜ ëª©í‘œì£¼ê°€ ë°ì´í„°ê°€ í˜„ì¬ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`
                });
            }

            // 6. Naspick AI Score & Tier (SEO: 'AI ë¶„ì„', 'ì£¼ì‹ í‹°ì–´' í‚¤ì›Œë“œ)
            let tierDescription = '';
            if (data.tier === 1) tierDescription = 'ìµœìƒìœ„ ë“±ê¸‰ìœ¼ë¡œ, í˜„ì¬ ì‹œì¥ì—ì„œ ê°€ì¥ ê°•ë ¥í•œ ìƒìŠ¹ ëª¨ë©˜í…€ê³¼ ìš°ìˆ˜í•œ í€ë”ë©˜í„¸ì„ ë³´ìœ í•œ ì¢…ëª©ì…ë‹ˆë‹¤.';
            else if (data.tier === 2) tierDescription = 'ìš°ëŸ‰ ë“±ê¸‰ìœ¼ë¡œ, ì•ˆì •ì ì¸ ì„±ì¥ì„±ê³¼ ì–‘í˜¸í•œ íˆ¬ì ë§¤ë ¥ë„ë¥¼ ê°–ì¶˜ ì¢…ëª©ì…ë‹ˆë‹¤.';
            else if (data.tier === 3) tierDescription = 'ë³´í†µ ë“±ê¸‰ìœ¼ë¡œ, ì‹œì¥ í‰ê·  ìˆ˜ì¤€ì˜ íë¦„ì„ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤.';
            else tierDescription = 'ì£¼ì˜ ë“±ê¸‰ìœ¼ë¡œ, í˜„ì¬ ëª¨ë©˜í…€ì´ë‚˜ í€ë”ë©˜í„¸ ê°œì„ ì´ í•„ìš”í•œ ìƒíƒœì…ë‹ˆë‹¤.';

            qnaList.push({
                q: `${data.name}(${data.ticker})ì˜ ë‚˜ìŠ¤í”½ AI ì ìˆ˜ì™€ í‹°ì–´ ë“±ê¸‰ì€ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?`,
                a: `${today} ê¸°ì¤€ ${data.name}ì˜ ë‚˜ìŠ¤í”½ AI ì¢…í•© ì ìˆ˜ëŠ” **${data.final_score}ì **ì´ë©°, **${data.tier}í‹°ì–´** ë“±ê¸‰ì…ë‹ˆë‹¤. ${tierDescription} ì´ ì ìˆ˜ëŠ” ê¸°ìˆ ì  ë¶„ì„, í€ë”ë©˜í„¸, ì‹œì¥ ì„¼í‹°ë¨¼íŠ¸ë¥¼ ì¢…í•©í•˜ì—¬ 15ë¶„ë§ˆë‹¤ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.`
            });

            // Render HTML (Accordion Style)
            const faqContainer = document.getElementById('faqSection');
            if (faqContainer) {
                faqContainer.innerHTML = `
                    <div class="mt-8 bg-[#23232a] rounded-xl border border-gray-800 p-6">
                        <h3 class="text-lg font-bold text-gray-200 mb-4 flex items-center gap-2">
                             ğŸ’¬ ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ (FAQ)
                        </h3>
                        <div class="space-y-3">
                            ${qnaList.map(item => `
                                <details class="group bg-[#1c1c1f] rounded-lg border border-gray-800/50 open:border-gray-700 transition-all">
                                    <summary class="flex justify-between items-center p-4 cursor-pointer list-none">
                                        <h4 class="font-bold text-gray-300 text-sm">Q. ${item.q}</h4>
                                        <svg class="w-4 h-4 text-gray-500 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </summary>
                                    <p class="px-4 pb-4 text-sm text-gray-400 leading-relaxed border-t border-gray-800/50 pt-3">
                                        ${item.a.replace(/\*\*(.*?)\*\*/g, '<span class="text-gray-200 font-bold">$1</span>')}
                                    </p>
                                </details>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Inject JSON-LD Schema
            const schemaData = {
                "@context": "https://schema.org",
                "@type": "FAQPage",
                "mainEntity": qnaList.map(item => ({
                    "@type": "Question",
                    "name": item.q,
                    "acceptedAnswer": {
                        "@type": "Answer",
                        "text": item.a.replace(/\*\*/g, '') // Remove markdown bold for schema
                    }
                }))
            };

            const script = document.createElement('script');
            script.type = 'application/ld+json';
            script.text = JSON.stringify(schemaData);
            document.head.appendChild(script);
        }

        // [NEW] Favorites Logic for Page
        function initFavorites(ticker) {
            const favorites = new Set(JSON.parse(localStorage.getItem('naspick_favorites') || '[]'));
            const container = document.getElementById('favoriteContainer');
            if (!container) return;

            // Render Button
            const isFav = favorites.has(ticker);
            renderFavoriteButton(container, isFav);

            // Click Handler
            container.onclick = (e) => {
                e.stopPropagation();
                if (favorites.has(ticker)) {
                    favorites.delete(ticker);
                } else {
                    favorites.add(ticker);
                }
                localStorage.setItem('naspick_favorites', JSON.stringify([...favorites]));

                // Update UI immediately
                renderFavoriteButton(container, favorites.has(ticker));
            };
        }

        function renderFavoriteButton(container, isFav) {
            container.innerHTML = `
                <button class="transition hover:scale-110 p-1 group">
                    <svg class="w-6 h-6 md:w-8 md:h-8 ${isFav ? 'text-yellow-400 fill-current' : 'text-gray-500 fill-transparent group-hover:text-yellow-400'}" 
                         xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" />
                    </svg>
                </button>
            `;
        }

        function initHeaderSearch() {
            const input = document.getElementById('headerSearch');
            const resultsDiv = document.getElementById('headerSearchResults');

            input.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase().replace(/\s+/g, ''); // Remove spaces
                if (!term) {
                    resultsDiv.classList.add('hidden');
                    return;
                }

                // Korean Chosung Helper
                const getChosung = (str) => {
                    const chosung = ["ã„±", "ã„²", "ã„´", "ã„·", "ã„¸", "ã„¹", "ã…", "ã…‚", "ã…ƒ", "ã……", "ã…†", "ã…‡", "ã…ˆ", "ã…‰", "ã…Š", "ã…‹", "ã…Œ", "ã…", "ã…"];
                    let result = "";
                    for (let i = 0; i < str.length; i++) {
                        const code = str.charCodeAt(i) - 44032;
                        if (code > -1 && code < 11172) {
                            result += chosung[Math.floor(code / 588)];
                        } else {
                            result += str.charAt(i);
                        }
                    }
                    return result;
                };

                // New: Jamo Helper
                const getJamo = (str) => {
                    const chosung = ["ã„±", "ã„²", "ã„´", "ã„·", "ã„¸", "ã„¹", "ã…", "ã…‚", "ã…ƒ", "ã……", "ã…†", "ã…‡", "ã…ˆ", "ã…‰", "ã…Š", "ã…‹", "ã…Œ", "ã…", "ã…"];
                    const jungsung = ["ã…", "ã…", "ã…‘", "ã…’", "ã…“", "ã…”", "ã…•", "ã…–", "ã…—", "ã…˜", "ã…™", "ã…š", "ã…›", "ã…œ", "ã…", "ã…", "ã…Ÿ", "ã… ", "ã…¡", "ã…¢", "ã…£"];
                    const jongsung = ["", "ã„±", "ã„²", "ã„³", "ã„´", "ã„µ", "ã„¶", "ã„·", "ã„¹", "ã„º", "ã„»", "ã„¼", "ã„½", "ã„¾", "ã„¿", "ã…€", "ã…", "ã…‚", "ã…„", "ã……", "ã…†", "ã…‡", "ã…ˆ", "ã…Š", "ã…‹", "ã…Œ", "ã…", "ã…"];

                    let result = "";
                    for (let i = 0; i < str.length; i++) {
                        const code = str.charCodeAt(i) - 44032;
                        if (code > -1 && code < 11172) {
                            const c = Math.floor(code / 588);
                            const j = Math.floor((code % 588) / 28);
                            const k = code % 28;
                            result += chosung[c] + jungsung[j];
                            if (k > 0) result += jongsung[k];
                        } else {
                            result += str.charAt(i);
                        }
                    }
                    return result;
                };

                // Helper: Decompose Compound Consonants
                const decomposeHangul = (str) => {
                    const doubleConsonants = {
                        'ã„³': 'ã„±ã……', 'ã„µ': 'ã„´ã…ˆ', 'ã„¶': 'ã„´ã…', 'ã„º': 'ã„¹ã„±', 'ã„»': 'ã„¹ã…',
                        'ã„¼': 'ã„¹ã…‚', 'ã„½': 'ã„¹ã……', 'ã„¾': 'ã„¹ã…Œ', 'ã„¿': 'ã„¹ã…', 'ã…€': 'ã„¹ã…', 'ã…„': 'ã…‚ã……'
                    };
                    return str.split('').map(char => doubleConsonants[char] || char).join('');
                };

                const normalize = (str) => str ? str.toLowerCase().replace(/\s+/g, '') : '';

                // Determine Search Mode
                const hasHangulSyllable = /[ê°€-í£]/.test(term);
                let matches = [];

                if (hasHangulSyllable) {
                    // [Mode A] Hybrid Jamo Search
                    const jamoTerm = getJamo(term);

                    matches = allData.filter(d => {
                        const normName = normalize(d.name);
                        return d.ticker.toLowerCase().includes(term) ||
                            normName.includes(term) ||
                            getJamo(normName).includes(jamoTerm) ||
                            (d.name_en && normalize(d.name_en).includes(term));
                    }).slice(0, 5);

                } else {
                    // [Mode B] Standard/Chosung Search
                    const normalizedTerm = decomposeHangul(term);
                    const chosungTerm = getChosung(normalizedTerm);

                    matches = allData.filter(d =>
                        d.ticker.toLowerCase().includes(term) ||
                        normalize(d.name).includes(normalizedTerm) ||
                        getChosung(normalize(d.name)).includes(chosungTerm) ||
                        (d.name && d.name.toLowerCase().includes(term)) ||
                        normalize(d.name_en).includes(normalizedTerm) ||
                        (d.name_en && d.name_en.toLowerCase().includes(term))
                    ).slice(0, 5);
                }

                if (matches.length > 0) {
                    // SEO ìˆ˜ì •: div onclick -> a href
                    resultsDiv.innerHTML = matches.map(d => {
                        let tierClass = 'text-gray-400 border-gray-600 bg-gray-700/20';
                        if (d.tier === 1) tierClass = 'text-[#0093ff] border-[#0093ff] bg-[#0093ff]/10';
                        else if (d.tier === 2) tierClass = 'text-[#00bba3] border-[#00bba3] bg-[#00bba3]/10';
                        else if (d.tier === 3) tierClass = 'text-[#ffb900] border-[#ffb900] bg-[#ffb900]/10';
                        else if (d.tier === 4) tierClass = 'text-[#9aa4af] border-[#9aa4af] bg-[#9aa4af]/10';
                        else if (d.tier === 5) tierClass = 'text-[#a07557] border-[#a07557] bg-[#a07557]/10';

                        const tierBadge = `<span class="px-1.5 py-0.5 text-[9px] font-bold rounded border ${tierClass}">${d.tier} Tier</span>`;

                        return `
                        <a href="/stock/${d.ticker}" class="p-2 hover:bg-[#3e63b0] cursor-pointer border-b border-gray-700 last:border-0 flex justify-between items-center block text-inherit hover:no-underline">
                            <div>
                                <span class="font-bold text-xs text-white">${d.ticker}</span>
                                <span class="text-[10px] text-gray-400 ml-1">${d.name}</span>
                            </div>
                            <div class="text-right">
                                <span class="text-[#5383e8] text-[10px] font-bold block">${d.final_score}</span>
                                <div class="mt-0.5">${tierBadge}</div>
                            </div>
                        </a>
                        `;
                    }).join('');
                    resultsDiv.classList.remove('hidden');
                } else {
                    resultsDiv.innerHTML = '<div class="p-2 text-gray-500 text-[10px]">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
                    resultsDiv.classList.remove('hidden');
                }
            });

            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !resultsDiv.contains(e.target)) {
                    resultsDiv.classList.add('hidden');
                }
            });
        }

        init();
    </script>

    <footer class="text-center text-[10px] md:text-xs text-gray-500 py-3 md:py-4 px-4 border-t border-gray-800 mt-6">
        <p>ë³¸ ì‚¬ì´íŠ¸ì˜ ì •ë³´ëŠ” íˆ¬ì ì°¸ê³ ìš©ì´ë©°, íˆ¬ì ê²°ì •ê³¼ ì†ìµì— ëŒ€í•œ ì±…ì„ì€ íˆ¬ìì ë³¸ì¸ì—ê²Œ ìˆìŠµë‹ˆë‹¤.</p>
        <p class="mt-1">Â© 2026 ë‚˜ìŠ¤í”½(NASPICK)</p>
    </footer>
</body>

</html>